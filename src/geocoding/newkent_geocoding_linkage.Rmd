---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
library(readxl)
library(dplyr)
library(stringr)
library(dataplumbr)
library(data.table)
library(leaflet)
```

```{r loc_function}
loc.validate_address <- function(id = "",
                                 address_1 = "",
                                 address_2 = "5141 HOPEWELL RD",  #"1100 Wilson Blvd",
                                 city =  "NEW KENT", #"Arlington",
                                 state = "VA",
                                 zip5 = "23124", #"",
                                 zip4 = "",
                                 full_info = TRUE,
                                 usps_userid = "789UNIVE1553") {
    if (full_info == TRUE) rev <- 1 else rev <- 0
    url <- paste0("https://secure.shippingapis.com/ShippingAPI.dll?API=Verify&XML=<AddressValidateRequest USERID=\"", usps_userid, "\">
        <Revision>", rev,"</Revision>
        <Address>
            <Address1>", address_1,"</Address1>
            <Address2>", address_2,"</Address2>
            <City>", city,"</City>
            <State>", state,"</State>
            <Zip5>", zip5,"</Zip5>
            <Zip4>", zip4,"</Zip4>
        </Address>
        </AddressValidateRequest>") %>%
        stringr::str_replace_all("(\n|\\s+)", " ") %>%
        utils::URLencode()
    ls <- xml2::as_list(xml2::read_xml(url))
    final <- t(as.data.frame(lapply(ls$AddressValidateResponse, unlist)))
    final <- final %>% bind_cols(rowid = id)
    final
}


# loc.validate_address(address_2 = "2 Maidens Bower Court", city = "Potomac", state = "MD", zip5 = "20854")
```


```{r county_data}
### COUNTY DATA
original_newkent_county <-read_excel("~/git/dspg20broadbandERS/data/new-kent-data/NK ASSESSMENT REPORT 2020.xlsx") #13,650
geocoded_newkent_county <- readRDS("~/git/dspg20broadbandERS/data/geocoding-output/geocoded_newkent_countydata_20JULY2020.RDS") #13,468

# subset_geocoded_nk <- geocoded_newkent_county %>% filter(!is.na(lat)) #,8988

```

```{r stand_county_data}

addresses <- data.table(
  # address1 = ,
  PID = original_newkent_county$`PID #`,
  address2 = original_newkent_county$`Property Location`,
  city = original_newkent_county$City,
  state = "VA",
  zip = str_extract(original_newkent_county$Zip, "\\d{5}")
)

if (exists("addr_final")) rm(addr_final)

for (i in 1:nrow(addresses)) {
  print(i)
  parsed <- loc.validate_address(
    id = addresses$PID[i], 
    address_1 = addresses$address1[i],
    address_2 = addresses$address2[i],
    city = addresses$city[i],
    zip5 = addresses$zip[i]
  ) %>%
    as.data.table() 
  if (exists("addr_final")) {
    addr_final <- rbindlist(list(addr_final, parsed), use.names = TRUE, fill = TRUE)
  } else {
    addr_final <- parsed
  }
}

# addr_final %>% saveRDS("~/git/dspg20broadbandERS/data/geocoding-output/new_kent_stand_addr_01AUG2020.RDS")
# addr_final <- readRDS("~/git/dspg20broadbandERS/data/geocoding-output/new_kent_stand_addr_01AUG2020.RDS")
addr_final_cty <- readRDS("~/git/dspg20broadbandERS/data/geocoding-output/new_kent_stand_addr_01AUG2020.RDS")
# rm(addr_final)
```

257 properties from New Kent County do not receive ANY standardization response (either error, NA, or actual stand address) from USPS:

* incorrect cities/zips - perhaps these are second homes
* intersections not addresses
* no house number
* King cross - either can't find it on google maps
* Quay Ct - points to empty lot on google maps
* King Bishop Ct - points to  the same empty lot on google maps
* Battlefield CM -  (commons) - points to same empty lot on google maps
* Prince Andrew - points to same empty lot on google maps for Quinton, for VA Beach, points to intersection 
* ALLINGTON CASTLE RD  - total mystery 

HOWEVER - 24 of these did geocode from census

```{r}
nrow(addresses)
nrow(addr_final_cty)

cty_didnt_standardize <- addresses %>% filter(PID %in% addr_final_cty$rowid == FALSE)
geocoded_newkent_county %>% filter(`PID #` %in% cty_didnt_standardize$PID == TRUE) %>% filter(method != "none")

```


in geocoded New Kent data - for the 67 PIDs with multiple lat/longs

```{r combine_county_data}
addr_final_subset <- addr_final_cty %>% 
  select(rowid, Address2, City, State, Zip5, Zip4, Error.Description, Vacant) %>% 
  distinct()

geocoded_newkent_county <- geocoded_newkent_county %>% 
  group_by(`PID #`, addr, method) %>% 
  summarise(lat = dplyr::first(lat), long = dplyr::first(long)) %>% 
  as.data.frame()

orig_county_stand_geo <- original_newkent_county %>% 
  left_join(addr_final_subset, by = c("PID #" = "rowid")) %>%
  left_join(geocoded_newkent_county, by = "PID #")

orig_county_stand_geo %>% count(#no_error = !is.na(Error.Description), 
                            stand_add = !is.na(Address2), 
                            coords = !is.na(lat))

# saveRDS(orig_county_stand_geo, "~/git/dspg20broadbandERS/data/geocoding-output/orig_nk_cty_stand_geo_01AUG2020.RDS")

# addr <- readRDS("~/git/dspg20broadbandERS/data/geocoding-output/new_kent_stand_addr.RDS")

orig_county_stand_geo <- readRDS("~/git/dspg20broadbandERS/data/geocoding-output/orig_nk_cty_stand_geo_01AUG2020.RDS")


```



```{r corelogic_data}

###### CORELOGIC DATA
# con <- get_db_conn()
# 
# nk_2018 <- DBI::dbGetQuery(con, statement = paste(
#   "SELECT fips_code, apn__parcel_number_unformatted_, apn_sequence_number, original_apn, census_tract, legal_lot_number, township, municipality_code,
#   property_indicator_code, assessed_total_value, market_total_value, tax_amount, tax_year, assessed_year,
#   acres, land_square_footage, building_square_feet, living_square_feet, year_built, effective_year_built,
#   bedrooms, total_baths, full_baths, half_baths, parcel_level_latitude, parcel_level_longitude, block_level_latitude, block_level_longitude,
#   situs_house_number, situs_street_name, situs_mode, situs_city, situs_state, situs_zip_code",
#   "FROM corelogic_sdad.tax_hist_2_51",
#   "WHERE fips_code='51127' AND tax_year = '2018' ")) #12,690
# 
# saveRDS(nk_2018, "~/original_newkent_corlogic2018data.RDS")
# DBI::dbDisconnect(con)

nk_2018 <- readRDS("~/original_newkent_corlogic2018data.RDS") %>% mutate(row_id = row_number())

# subset_cl_nk <- nk_2018 %>% filter(!is.na(parcel_level_latitude)) #12,359

```


```{r}
addresses <- data.table(
  ID = nk_2018$row_id,
  # address1 = ,
  address2 = paste(ifelse(!is.na(nk_2018$situs_house_number), nk_2018$situs_house_number, ""), 
                   ifelse(!is.na(nk_2018$situs_house_number), nk_2018$situs_street_name, ""), 
                   ifelse(!is.na(nk_2018$situs_house_number), nk_2018$situs_mode, "") 
                   ),
  city = ifelse(!is.na(nk_2018$situs_city), nk_2018$situs_city, ""), 
  state = "VA",
  zip = str_extract(nk_2018$situs_zip_code, "\\d{5}")
)

if (exists("addr_final")) rm(addr_final)

for (i in 10313:nrow(addresses)) {
  print(i)
  parsed <- loc.validate_address(
    id = addresses$ID[i], 
    address_1 = addresses$address1[i],
    address_2 = addresses$address2[i],
    city = addresses$city[i],
    zip5 = addresses$zip[i]
  ) %>%
    as.data.table() 
  if (exists("addr_final")) {
    addr_final <- rbindlist(list(addr_final, parsed), use.names = TRUE, fill = TRUE)
  } else {
    addr_final <- parsed
  }
}

# addr_final %>% saveRDS("~/git/dspg20broadbandERS/data/geocoding-output/new_kent_CL_stand_addr_pt1_01AUG2020.RDS")
# addr_final %>% saveRDS("~/git/dspg20broadbandERS/data/geocoding-output/new_kent_CL_stand_addr_pt2_01AUG2020.RDS")
addr_final_cl <- readRDS("~/git/dspg20broadbandERS/data/geocoding-output/new_kent_CL_stand_addr_pt2_01AUG2020.RDS")
```

```{r}
addr_final_subset <- addr_final %>% 
  select(rowid, Address2, City, State, Zip5, Zip4, Error.Description, Vacant) %>% 
  distinct()

orig_cl_stand_geo <- nk_2018 %>% 
  left_join(addr_final_subset, by = c("row_id" = "rowid")) 
  

orig_cl_stand_geo %>% count(#no_error = !is.na(Error.Description), 
                            stand_add = !is.na(Address2), 
                            coords = !is.na(parcel_level_latitude))

# saveRDS(orig_cl_stand_geo, "~/git/dspg20broadbandERS/data/geocoding-output/orig_nk_cl_stand_geo_01AUG2020.RDS")

orig_cl_stand_geo <- readRDS("~/git/dspg20broadbandERS/data/geocoding-output/orig_nk_cl_stand_geo_01AUG2020.RDS")

```

#### SUMMARISE

```{r}
data.frame("PHASE" = c("A", "A", "A", "B", "B", "B"),
           "STEP" = c("Original", "Stand Output", "Combined", "Coords", "Address - String", "Address - Stand"), 
           "COUNTY" = c(nrow(original_newkent_county), nrow(addr_final_cty), 
                        nrow(orig_county_stand_geo), 
                        sum(!is.na(orig_county_stand_geo$lat)),  
                        sum(!is.na(orig_county_stand_geo$`Property Location`)), 
                        sum(!is.na(orig_county_stand_geo$Address2))
                        ), 
           "CORELOGIC" = c(nrow(nk_2018), nrow(addr_final_cl), 
                           nrow(orig_cl_stand_geo), 
                           sum(!is.na(orig_cl_stand_geo$parcel_level_latitude)),
                           sum(!is.na(orig_cl_stand_geo$situs_street_name)), 
                           sum(!is.na(orig_cl_stand_geo$Address2))
                           )
           )

```



#### PREP FOR MATCHING

```{r}
orig_cl_stand_geo <- readRDS("~/git/dspg20broadbandERS/data/geocoding-output/orig_nk_cl_stand_geo_01AUG2020.RDS")
orig_county_stand_geo <- readRDS("~/git/dspg20broadbandERS/data/geocoding-output/orig_nk_cty_stand_geo_01AUG2020.RDS")

cty_prep_to_match <- orig_county_stand_geo %>% #head() %>% 
  select(`PID #`, 
         `Property Location`, City.x, State.x, 
         Address2, City.y, State.y, Zip5, Zip4, 
         lat, long, 
         Error.Description, Vacant, method)

cl_prep_to_match  <- orig_cl_stand_geo %>% # head() %>% 
  select(row_id, 
         situs_house_number, situs_street_name, situs_mode, situs_city, situs_state, situs_zip_code, 
         Address2, City, State, Zip5, Zip4, 
         parcel_level_latitude, parcel_level_longitude, 
         Error.Description, Vacant) %>% 
  mutate(method = "corelogic",
         PropertyLocation1 = paste(situs_house_number, situs_street_name, situs_mode), 
         PropertyLocation2 = paste(situs_house_number, situs_street_name))

ctyrepeatonPL <- cty_prep_to_match %>% count(`Property Location`) %>% filter(n > 1)
clrepeatonPL <- cl_prep_to_match %>% count(PropertyLocation1) %>% filter(n > 1)
clrepeatonPL2 <- cl_prep_to_match %>% count(PropertyLocation2) %>% filter(n > 1)

cty_prep_to_match <- cty_prep_to_match %>% 
  mutate(repeats = ifelse(`Property Location` %in% ctyrepeatonPL$`Property Location`, 1, 0))
table(cty_prep_to_match$repeats)

cl_prep_to_match <- cl_prep_to_match %>% 
  mutate(repeats1 = ifelse(PropertyLocation1 %in% clrepeatonPL$PropertyLocation1, 1, 0),
         repeats2 = ifelse(PropertyLocation2 %in% clrepeatonPL2$PropertyLocation2, 1, 0))
# table(cl_prep_to_match$repeats1)
# table(cl_prep_to_match$repeats2)

```

#### MATCHING - PASS 1 - no repeats - street address - county_only (not standardized)

```{r}
cty_prep_to_match_PASS1 <- cty_prep_to_match %>% 
  filter(repeats == 0) 

cl_prep_to_match_PASS1 <- cl_prep_to_match %>% 
  filter(repeats1 == 0 & repeats2 == 0) 

# nrow(cty_prep_to_match_PASS1) #10,054
# nrow(cl_prep_to_match_PASS1) #9,831

pass1_matched <- cty_prep_to_match_PASS1 %>% inner_join(cl_prep_to_match_PASS1, by =  c("Property Location" = "PropertyLocation1")) 

# nrow(pass1_matched) #7,076
# pass1_matched %>% count(`PID #`) %>% filter(n>1)
# pass1_matched %>% count(row_id) %>% filter(n>1)


cty_prep_to_match_PASS2 <- cty_prep_to_match_PASS1 %>% # should I anti-join here instead?
  filter(`PID #` %in% pass1_matched$`PID #` == FALSE)

cl_prep_to_match_PASS2 <- cl_prep_to_match_PASS1 %>%
  filter(row_id %in% pass1_matched$row_id == FALSE)
```

#### MATCHING - PASS 2 - no repeats - street address - county_only but without MODE (not standardized)

```{r}
# nrow(cty_prep_to_match_PASS2) #2,978
# nrow(cl_prep_to_match_PASS2) #2,305

pass2_matched <- cty_prep_to_match_PASS2 %>% inner_join(cl_prep_to_match_PASS2, by =  c("Property Location" = "PropertyLocation2")) 

# nrow(pass2_matched) #17
# pass2_matched %>% count(`PID #`) %>% filter(n>1)
# pass2_matched %>% count(row_id) %>% filter(n>1)

cty_prep_to_match_PASS3 <- cty_prep_to_match_PASS2 %>% # should I anti-join here instead?
  filter(`PID #` %in% pass2_matched$`PID #` == FALSE)

cl_prep_to_match_PASS3 <- cl_prep_to_match_PASS2 %>%
  filter(row_id %in% pass2_matched$row_id == FALSE)

pass1_2_matched <- rbind(pass1_matched %>% select(-PropertyLocation2), pass2_matched %>% select(-PropertyLocation1))
# nrow(pass1_2_matched) #7,093
```


#### MATCHING - PASS 3 - no repeats AND no blank Address2 - street address - standardized

```{r}
cty_returntomatchthese <- cty_prep_to_match_PASS3 %>% filter(is.na(Address2)) 
cty_returntomatchthese %>% select(`Property Location`, Address2, lat, long) %>% head()
cl_returntomatchthese <- cl_prep_to_match_PASS3 %>% filter(is.na(Address2)) 
cl_returntomatchthese %>% select(PropertyLocation1, Address2, parcel_level_latitude, parcel_level_longitude) %>% head()


cty_prep_to_match_PASS3 <- cty_prep_to_match_PASS3 %>% filter(!is.na(Address2)) 
cl_prep_to_match_PASS3 <- cl_prep_to_match_PASS3 %>% filter(!is.na(Address2)) 


# nrow(cty_prep_to_match_PASS3) #1,240
# nrow(cl_prep_to_match_PASS3) #2,101

pass3_matched <- cty_prep_to_match_PASS3 %>% inner_join(cl_prep_to_match_PASS3, by =  c("Address2", "City.y" = "City", "State.y" = "State", "Zip5", "Zip4")) 

# nrow(pass3_matched) #956
# pass3_matched %>% count(`PID #`) %>% filter(n>1) # PID == 10439 w 2 rows --> join created extra row
# pass3_matched %>% count(row_id) %>% filter(n>1)

cty_prep_to_match_PASS4 <- cty_prep_to_match_PASS3 %>% # should I anti-join here instead?
  filter(`PID #` %in% pass3_matched$`PID #` == FALSE)

cl_prep_to_match_PASS4 <- cl_prep_to_match_PASS3 %>%
  filter(row_id %in% pass3_matched$row_id == FALSE)


##### Investigating the second row

pass3_matched %>% filter(`PID #` == 10439)
cl_prep_to_match_PASS3 %>% filter(row_id == "9626")

# pass3_matched %>% select(`Property Location`, PropertyLocation1, Address2) %>% 
#   mutate(dist = stringdist::stringdist(PropertyLocation1, Address2)) %>%
#   filter(dist >  0) %>% 
#   arrange(desc(dist))

# original_newkent_county %>% filter(`PID #` == 10439)
# nk_2018 %>% filter(row_id == "9626")
# 
# colnames(pass1_2_matched)
# print("  ")
# colnames(pass3_matched %>% select(-PropertyLocation1, -PropertyLocation2))
# setdiff(colnames(pass1_2_matched), colnames(pass3_matched %>% select(-PropertyLocation1, -PropertyLocation2, -Address2, -Zip5, -Zip4)))
# setdiff(colnames(pass3_matched %>% select(-PropertyLocation1, -PropertyLocation2, -Address2, -Zip5, -Zip4)), colnames(pass1_2_matched))

### Combining everything for sf purposes - can ignore? 

pass1_2_3_matched <- rbind(pass1_2_matched %>% select(-Address2.x, -Zip5.x, -Zip4.x, -Address2.y, -City, -State, -Zip5.y, -Zip4.y), pass3_matched %>% select(-PropertyLocation1, -PropertyLocation2, -Address2, -Zip5, -Zip4))
```


```{r}
# nrow(cty_prep_to_match_PASS4) #329
# nrow(cl_prep_to_match_PASS4) #1123
```


```{r}
data.frame( #"PHASE" = c("A", "A", "A", "B", "B", "B"),
           "STEP" = c("Preparation", "SET ASIDE - Address Repeats", "Non Repeats", 
                      "Pass 1 - Full Add", # "Pass 1 - Missed",
                      "Pass 2 - w/o Mode", #"Pass 2 - Missed",
                      "Pass 3 - Stand Add w/o blanks", "MISSED - from Pass 3",
                      "SET ASIDE - Stand Add Missing"
                      ), 
           "COUNTY" = c(nrow(cty_prep_to_match), sum(cty_prep_to_match$repeats),
                        nrow(cty_prep_to_match) - sum(cty_prep_to_match$repeats),
                        nrow(pass1_matched),# nrow(cty_prep_to_match_PASS2),
                        nrow(pass2_matched), # nrow(cty_prep_to_match_PASS3),
                        nrow(pass3_matched),  nrow(cty_prep_to_match_PASS4),
                        nrow(cty_returntomatchthese)
                        ), 
           "CORELOGIC" = c(nrow(cl_prep_to_match), cl_prep_to_match %>% filter(repeats1 ==1|repeats2 == 1) %>% nrow(),
                           nrow(cl_prep_to_match) - cl_prep_to_match %>% filter(repeats1 ==1|repeats2 == 1) %>% nrow(),
                           nrow(pass1_matched), # nrow(cl_prep_to_match_PASS2),
                           nrow(pass2_matched),# nrow(cl_prep_to_match_PASS3),
                           nrow(pass3_matched), nrow(cl_prep_to_match_PASS4),
                           nrow(cl_returntomatchthese)
                           )
           )
```

TO add this up correctly
Eligible Non Repeats = 
PAss 1 + 2  + 3  + Pass 3 Missed + Leftovers

```{r}
10121 # eligble, non repeats
7090 + 17 + 964 + 329 + 1722 
#(one off because that one row matched twice because address standardized to duplicate address)

9381
7090 + 17 + 964 + 1123+ 187
```

```{r}
# cty_prep_to_match_PASS4
# cty_returntomatchthese

unmatched_cty_nonrepeats <- rbind(cty_prep_to_match_PASS4, cty_returntomatchthese)
unmatched_cl_nonrepeats <- rbind(cl_prep_to_match_PASS4, cl_returntomatchthese)

streets <- read.csv("~/git/dspg20broadbandERS/data/geocoding-output/street_abbreviations.csv")

unmatched_cty_nonrepeats <- unmatched_cty_nonrepeats %>%
  mutate(addr_mode = str_extract(`Property Location`, "\\b[A-Z]{2,3}$"),
         PropertyLocation2 = str_squish(str_remove(`Property Location`, pattern = paste0(addr_mode, "$"))))

######

# nrow(unmatched_cty_nonrepeats) #2,051
# nrow(unmatched_cl_nonrepeats) #1,310

pass4_matched <- unmatched_cty_nonrepeats %>% inner_join(unmatched_cl_nonrepeats, by = "PropertyLocation2")

nrow(pass4_matched) #889
pass4_matched %>% count(`PID #`) %>% filter(n>1)
pass4_matched %>% count(row_id) %>% filter(n>1)

cty_prep_to_match_PASS5 <- unmatched_cty_nonrepeats %>% # should I anti-join here instead?
  filter(`PID #` %in% pass4_matched$`PID #` == FALSE)

cl_prep_to_match_PASS5 <- unmatched_cl_nonrepeats %>%
  filter(row_id %in% pass4_matched$row_id == FALSE)


```



```{r}
data.frame("PHASE" = c("Prep", "Set Aside", "Prep", "Matching", "Matching", "Matching", "Prep - 4", "Prep - 4", "Matching", "Prep/Missed"),
           "STEP" = c("Preparation", "SET ASIDE - Address Repeats", "Non Repeats", 
                      "Pass 1 - Full Add", # "Pass 1 - Missed",
                      "Pass 2 - w/o Mode", #"Pass 2 - Missed",
                      "Pass 3 - Stand Add w/o blanks", "MISSED - from Pass 3",
                      "SET ASIDE - Stand Add Missing", "Pass 4", "MISSED - from Pass 4"
                      ), 
           "COUNTY" = c(nrow(cty_prep_to_match), sum(cty_prep_to_match$repeats),
                        nrow(cty_prep_to_match) - sum(cty_prep_to_match$repeats),
                        nrow(pass1_matched),# nrow(cty_prep_to_match_PASS2),
                        nrow(pass2_matched), # nrow(cty_prep_to_match_PASS3),
                        nrow(pass3_matched),  nrow(cty_prep_to_match_PASS4),
                        nrow(cty_returntomatchthese),
                        nrow(pass4_matched), nrow(cty_prep_to_match_PASS5)
                        ), 
           "CORELOGIC" = c(nrow(cl_prep_to_match), cl_prep_to_match %>% filter(repeats1 ==1|repeats2 == 1) %>% nrow(),
                           nrow(cl_prep_to_match) - cl_prep_to_match %>% filter(repeats1 ==1|repeats2 == 1) %>% nrow(),
                           nrow(pass1_matched), # nrow(cl_prep_to_match_PASS2),
                           nrow(pass2_matched),# nrow(cl_prep_to_match_PASS3),
                           nrow(pass3_matched), nrow(cl_prep_to_match_PASS4),
                           nrow(cl_returntomatchthese),
                           nrow(pass4_matched), nrow(cl_prep_to_match_PASS5)
                           )
           )
```

```{r}
total_matched <- nrow(pass1_matched) + nrow(pass2_matched) + nrow(pass3_matched) + nrow(pass4_matched)
```


```{r}
cty_prep_to_match_PASS_R <- cty_prep_to_match %>% 
  filter(repeats == 1) 

cl_prep_to_match_PASS_R <- cl_prep_to_match %>% 
  filter(repeats1 == 1 | repeats2 == 1) 

cty_prep_to_match_PASS_R %>% filter(str_detect(`Property Location`, "^\\d") == FALSE)
cty_prep_to_match_PASS_R %>% filter(str_detect(`Property Location`, "^\\d") == TRUE)
cl_prep_to_match_PASS_R %>% filter(str_detect(PropertyLocation1, "^NA"))
cl_prep_to_match_PASS_R %>% filter(str_detect(PropertyLocation1, "^NA") == FALSE)
```


## geocode CORELOGIC NEW KENT!!!

```{r}
library(leaflet)

table(is.na(pass1_2_matched$parcel_level_latitude))

pass1_2_matched_sf <- sf::st_as_sf(pass1_2_matched %>% filter(!is.na(parcel_level_latitude)), coords = c("parcel_level_longitude", "parcel_level_latitude"))

pass1_2_3_matched_sf <- sf::st_as_sf(pass1_2_3_matched %>% filter(!is.na(parcel_level_latitude)), coords = c("parcel_level_longitude", "parcel_level_latitude"))

leaflet(pass1_matched_sf) %>%
  addTiles() %>%
  addCircleMarkers(radius = 0.5) 

# What matched in rounds 1,2,3
leaflet(pass1_2_3_matched_sf) %>%
  addTiles() %>%
  addCircleMarkers(radius = 0.5) 
  # addCircleMarkers(lat = as.numeric(pass3_matched$parcel_level_latitude), lng = as.numeric(pass3_matched$parcel_level_longitude), radius = 0.5, color = "#32CD32")

# What hasn't matched in rounds 1,2,3

unmatched_cty_pass4 <- cty_prep_to_match_PASS4 %>% filter(!is.na(lat))
unmatched_cl_pass4 <- cl_prep_to_match_PASS4 %>% filter(!is.na(parcel_level_latitude))

library(htmltools)

leaflet(pass1_2_matched_sf) %>%
  addTiles() %>%
  addCircleMarkers(radius = 0.5, color = "#32CD32", popup = ~htmlEscape(`Property Location`)) %>%
  # Pass 3 Matched
  addCircleMarkers(lat = as.numeric(pass3_matched$parcel_level_latitude), 
                   lng = as.numeric(pass3_matched$parcel_level_longitude), 
                   radius = 0.5, color = "#32CD32", 
                   popup = ~htmlEscape(pass3_matched$`Property Location`)) %>%
  # Unmatched CTY after Pass 3
  addCircleMarkers(lat = unmatched_cty_pass4$lat, lng = unmatched_cty_pass4$long, 
                   radius  = 0.5, color = "#ff0000",
                   popup = ~htmlEscape(unmatched_cty_pass4$`Property Location`)) %>%
  # Set aside CTY from blank stand address
  addCircleMarkers(lat = cty_returntomatchthese$lat, lng = cty_returntomatchthese$long, 
                   radius  = 0.5, color = "#ff0000",
                   popup = ~htmlEscape(cty_returntomatchthese$`Property Location`)) %>% 
  # Unmatched CL after pass 3
  addCircleMarkers(lat = as.numeric(unmatched_cl_pass4$parcel_level_latitude), 
                   lng =as.numeric(unmatched_cl_pass4$parcel_level_longitude), 
                   radius = 0.5, color = "#0000FF",
                   popup = ~htmlEscape(unmatched_cl_pass4$`PropertyLocation1`)) %>%
  # Set aside CL from blank stand address
  addCircleMarkers(lat = as.numeric(cl_returntomatchthese$parcel_level_latitude), lng = as.numeric(cl_returntomatchthese$parcel_level_longitude), 
                   radius = 0.5, color = "#0000FF",
                   popup = ~htmlEscape(cl_returntomatchthese$PropertyLocation1))


leaflet(unmatched_cty_nonrepeats) %>%
  addTiles() %>% 
  addCircleMarkers(radius = 0.5, color = "#ff0000", popup = ~htmlEscape(`Property Location`)) %>%
  addCircleMarkers(lat = as.numeric(unmatched_cl_nonrepeats$parcel_level_latitude), 
                   lng = as.numeric(unmatched_cl_nonrepeats$parcel_level_longitude), 
                   radius = 0.5, color = "#0000FF", popup = ~htmlEscape(unmatched_cl_nonrepeats$PropertyLocation1))

leaflet() %>% 
  addTiles() %>%
  addCircleMarkers(radius = 0.5, lat = as.numeric(pass4_matched$parcel_level_latitude), lng = as.numeric(pass4_matched$parcel_level_longitude))

leaflet(unmatched_cty_nonrepeats) %>%
  addTiles() %>% 
  addCircleMarkers(radius = 0.5, color = "#ff0000", popup = ~htmlEscape(`Property Location`)) %>%
  addCircleMarkers(lat = as.numeric(unmatched_cl_nonrepeats$parcel_level_latitude), 
                   lng = as.numeric(unmatched_cl_nonrepeats$parcel_level_longitude), 
                   radius = 0.5, color = "#0000FF", popup = ~htmlEscape(unmatched_cl_nonrepeats$addr_rep)) %>%
  addCircleMarkers(radius = 0.5, lat = as.numeric(pass4_matched$parcel_level_latitude), lng = as.numeric(pass4_matched$parcel_level_longitude), color = "#32CD32")


```


WHAT MATCHED VIA WHAT PASS

```{r}
pass1_matched_sf <- pass1_matched %>% filter(!is.na(parcel_level_latitude)) %>% sf::st_as_sf(coords = c("parcel_level_longitude", "parcel_level_latitude"))
library(htmltools)
leaflet(pass1_matched_sf) %>%
  addTiles() %>%
  # PASS 1 Matched
  addCircleMarkers(lat = as.numeric(pass1_matched$parcel_level_latitude), lng = as.numeric(pass1_matched$parcel_level_longitude),
                   radius = 0.5, color = "#ff6767", 
                   popup = ~htmlEscape(pass1_matched$`Property Location`))  %>%
  # PASS 2 MATCHED
    addCircleMarkers(lat = as.numeric(pass2_matched$parcel_level_latitude), lng = as.numeric(pass2_matched$parcel_level_longitude),
                   radius = 0.5, color = "#32CD32", 
                   popup = ~htmlEscape(pass2_matched$`Property Location`)) %>%
  # Pass 3 Matched
  addCircleMarkers(lat = as.numeric(pass3_matched$parcel_level_latitude), 
                   lng = as.numeric(pass3_matched$parcel_level_longitude), 
                   radius = 0.5, color = "#41406d", 
                   popup = ~htmlEscape(pass3_matched$`Property Location`))  %>%
  # PASS 4 MAtched
  addCircleMarkers(lat = as.numeric(pass4_matched$parcel_level_latitude), lng = as.numeric(pass4_matched$parcel_level_longitude),
                   radius = 0.5, color = "#32CD32", 
                   popup = ~htmlEscape(pass4_matched$`Property Location`))
```


```{r}
leaflet(pass1_matched_sf) %>%
  addTiles() %>%
  # PASS 4 Missed (prep for a future 5)
  addCircleMarkers(lat = as.numeric(cty_prep_to_match_PASS5$lat), 
                   lng = as.numeric(cty_prep_to_match_PASS5$long),
                   radius = 0.5, color = "#ff6767", 
                   popup = ~htmlEscape(cty_prep_to_match_PASS5$`Property Location`))  %>%
  # PASS 4 Missed (prep for a future 5)
    addCircleMarkers(lat = as.numeric(cl_prep_to_match_PASS5$parcel_level_latitude), 
                     lng = as.numeric(cl_prep_to_match_PASS5$parcel_level_longitude),
                   radius = 0.5, color = "#32CD32", 
                   popup = ~htmlEscape(cl_prep_to_match_PASS5$PropertyLocation1)) %>%
  setView(lat = 37.511136, lng = -77.009578, zoom = 11)

```


```{r}
leaflet(pass1_matched_sf) %>%
  addTiles() %>%
  # PREP - CTY REPEATS
  addCircleMarkers(lat = as.numeric(cty_prep_to_match_PASS_R$lat), 
                   lng = as.numeric(cty_prep_to_match_PASS_R$long), 
                   radius = 0.5, color = "#ff6767", 
                   popup = ~htmlEscape(cty_prep_to_match_PASS_R$`Property Location`))  %>%
  # PREP - CL REPEATS
  addCircleMarkers(lat = as.numeric(cl_prep_to_match_PASS_R$parcel_level_latitude), lng = as.numeric(cl_prep_to_match_PASS_R$parcel_level_longitude),
                   radius = 0.5, color = "#32CD32", 
                   popup = ~htmlEscape(cl_prep_to_match_PASS_R$PropertyLocation1)) %>%
  setView(lat = 37.511136, lng = -77.009578, zoom = 11)
```

```{r}
cty_prep_to_match_PASS_R_dig <- cty_prep_to_match_PASS_R %>% filter(str_detect(`Property Location`, "^\\d") == TRUE)
cl_prep_to_match_PASS_R_dig <- cl_prep_to_match_PASS_R %>% filter(!is.na(situs_house_number))
```


```{r}


leaflet(pass1_matched_sf) %>%
  addTiles() %>%
  # PREP - CTY REPEATS
  addCircleMarkers(lat = as.numeric(cty_prep_to_match_PASS_R_dig$lat), 
                   lng = as.numeric(cty_prep_to_match_PASS_R_dig$long), 
                   radius = 0.5, color = "#ff6767", 
                   popup = ~htmlEscape(cty_prep_to_match_PASS_R_dig$`Property Location`))  %>%
  # PREP - CL REPEATS
  addCircleMarkers(lat = as.numeric(cl_prep_to_match_PASS_R_dig$parcel_level_latitude), lng = as.numeric(cl_prep_to_match_PASS_R_dig$parcel_level_longitude),
                   radius = 0.5, color = "#32CD32", 
                   popup = ~htmlEscape(cl_prep_to_match_PASS_R_dig$PropertyLocation1)) %>%
  setView(lat = 37.511136, lng = -77.009578, zoom = 11)
```


















OLD

```{r eval = FALSE}
cl_stand <- readRDS("~/git/dspg20broadbandERS/data/geocoding-output/new_kent_cl_stand_addr_1.RDS")
cty_stand <- readRDS("~/git/dspg20broadbandERS/data/geocoding-output/new_kent_stand_addr.RDS")

cl_stand_nona <- cl_stand %>% filter(!is.na(Address2)) %>% select(-1, -2, -3)
cty_stand_nona <- cty_stand %>% filter(!is.na(Address2))

cty_matched_stand <- cty_stand_nona %>% inner_join(cl_stand_nona, by = c("Address2", "City", "State", "Zip5", "Zip4")) %>% mutate(addr = paste0(Address2, ", ", City, ", ", State, ", ", Zip5))

# cty_matched_geo <- tidygeocoder::geo_cascade(head(cty_matched_stand$addr))

data_list <- list()
# cty_matched_stand[,"addr"]
# colnames(cty_matched_stand)

for (i in 1:3650) { #nrow(cty_matched_stand)
  print(i)
  #to see whether geocode in census works
  # lat_long <- tidygeocoder::geo_cascade(cty_matched_stand$addr[i])
  # if lat, long is NA
  # if (is.na(lat_long$lat)) {
    # lat_long <- tidygeocoder::geocode(cty_matched_stand[i, c("addr")], addr, method = "osm") %>%
    # mutate(method = ifelse(is.na(lat), "none", "osm"))
  # }
      tryCatch({
        lat_long <- tidygeocoder::geo_cascade(cty_matched_stand$addr[i])
      }, 
        error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
data_list[[i]] <- lat_long

}
cty_matched_geo <- do.call(rbind, data_list)
# cty_matched_geo %>% saveRDS("~/cl_cty_matched_geocoded.RDS")

cty_matched_geo %>% head()
table(cty_matched_geo$geo_method)

```

```{r eval = FALSE}
cty_matched_geo <- readRDS("~/cl_cty_matched_geocoded.RDS") 

original_newkent_county
nk_2018
cty_matched_geo

data.frame("Results" = c("Matched", "CL TOTAL", "CTY TOTAL", "CL MISSED", "CTY MISSED"), 
           "Values" = c(nrow(cty_matched_geo), nrow(nk_2018), nrow(original_newkent_county), nrow(nk_2018) - nrow(cty_matched_geo), nrow(original_newkent_county) - nrow(cty_matched_geo)))

matched <- nrow(cty_matched_geo)
cl_total <- nrow(nk_2018)
cty_total <- nrow(original_newkent_county)
cl_stand <- nrow(cl_stand)
cty_stand <- nrow(cty_stand)
cl_stan_nona <- nrow(cl_stand_nona)
cty_stan_nona <- nrow(cty_stand_nona)

data.frame("Results" = c("1. TOTAL", "2. POST_STAND", "3. MINUS NA", "4. MATCHED", "% MATCH/TOTAL", "% MATCH/STAND"), 
           "CoreLogic" = c( cl_total,  cl_stand, cl_stan_nona, matched, scales::percent(matched/cl_total), scales::percent(matched/cl_stan_nona)),
           "County" = c(cty_total, cty_stand, cty_stan_nona, matched, scales::percent(matched/cty_total), scales::percent(matched/cty_stan_nona))
           )
```


```{r eval = FALSE}

library(leaflet)

# va_counties <- tigris::counties(state = "VA")
# url <- "https://www2.census.gov/geo/tiger/TIGER2018/COUNTY/tl_2018_us_county.zip"
# download.file(url, destfile = "~/tl_2018_us_county.zip")
# test <- sf::st_read(unzip("~/tl_2018_us_county.zip")[4])
# newkent <- test %>% filter(STATEFP == "51") %>% filter(str_detect(NAMELSAD, "Kent"))
# saveRDS(newkent, "~/git/dspg20broadbandERS/data/new-kent-data/newkent_county_outline.RDS")
newkent <- readRDS( "~/git/dspg20broadbandERS/data/new-kent-data/newkent_county_outline.RDS")
RUCA <- readr::read_csv("~/git/dspg20broadbandERS/data/census-geographies/RUCA.csv")

newkentruca <- RUCA %>% filter(State == "VA" & County == "New Kent County")

# newkenttracts <- tigris::tracts(state = "VA", county = "127")
# saveRDS(newkenttracts, "~/git/dspg20broadbandERS/data/census-geographies/newkent_tracts.RDS")
newkenttracts <- readRDS("~/git/dspg20broadbandERS/data/census-geographies/newkent_tracts.RDS") 
newkenttracts <- newkenttracts %>% left_join(newkentruca, by = "GEOID")

leaflet(newkenttracts) %>%
  addTiles() %>% 
  addCircleMarkers(lng = cty_matched_geo$long, lat = cty_matched_geo$lat, radius = 0.5) %>%
  addPolygons(color = "#GGGGGG")

library(sf)
subset_geocoded_nk_sf <-  sf::st_as_sf(subset_geocoded_nk, coords = c("lat", "long"))
# subset_geocoded_nk <- subset_geocoded_nk %>% filter(str_detect(addr, ", VA, ") == TRUE)
# subset_geocoded_nk #8942
subset_geocoded_nk_sf <- cbind(subset_geocoded_nk_sf, subset_geocoded_nk$lat, subset_geocoded_nk$long)

st_crs(subset_geocoded_nk_sf) <- st_crs(newkent)
# subset_geocoded_nk_sf <- subset_geocoded_nk_sf %>% st_transform(st_crs(newkent))
# subset_geocoded_nk_sf_nkONLY <-  subset_geocoded_nk_sf %>% filter(sf::st_within(x = ., y = newkent) == TRUE)
# subset_geocoded_nk_sf <- subset_geocoded_nk_sf %>% head(10) %>% mutate(within = st_intersects(newkent))
# subset_geocoded_nk_sf
# apply(X = subset_geocoded_nk_sf %>% head(100), MARGIN = 1, FUN = st_intersects(y = newkent))
test <- st_intersects(x = subset_geocoded_nk_sf, y = newkent, sparse = FALSE)
test <- st_intersects(x = newkent, y = subset_geocoded_nk_sf, sparse = FALSE)
table(lengths(test))
test2 <- apply(test, 1, any)
length(test2)
table(test2)

table(str_extract(subset_geocoded_nk$lat, "\\d\\d"))

subset_geocoded_nk <- subset_geocoded_nk %>% filter(str_extract(lat, "\\d\\d") %in% c(36:38)& str_extract(long, "\\d\\d") %in% c(75:78))

print("New Kent Census Tracts")

leaflet(newkenttracts) %>%
  addTiles() %>% 
  # addCircleMarkers(lng = cty_matched_geo$long, lat = cty_matched_geo$lat, radius = 0.5) %>%
  addPolygons()

print("New Kent - Houses in both CL & CTY data")

leaflet(newkenttracts) %>%
  addTiles() %>% 
  addCircleMarkers(lng = cty_matched_geo$long, lat = cty_matched_geo$lat, radius = 0.5) %>%
  addPolygons(color = "#GGGGGG")

print("New Kent - Houses in CTY data (that were geocoded without standardization)")

leaflet(newkent) %>%
  addTiles() %>% 
  addCircleMarkers(lat = subset_geocoded_nk$lat, lng = subset_geocoded_nk$long, radius = 0.5) %>%
  addPolygons(color = "#GGGGGG")

print("New Kent - Houses in CL data (using CL geocoding)")

leaflet(newkent) %>%
  addTiles() %>% 
  addCircleMarkers(lat = as.numeric(nk_2018$parcel_level_latitude), lng = as.numeric(nk_2018$parcel_level_longitude), radius = 0.5) %>%
  addPolygons(color = "#GGGGGG")

```


```{r eval = FALSE}
county_parsely <- subset_geocoded_nk %>% filter(str_detect(addr, "^12110"))

corelogic_parsley <- subset_cl_nk %>% filter(situs_house_number == "12110")


library(sf)
st_geometry(subset_geocoded_nk)
st_geometry(subset_cl_nk)

st_crs(subset_geocoded_nk)
st_crs(subset_cl_nk)

subset_geocoded_nk <- st_as_sf(subset_geocoded_nk, coords = c("lat", "long"), 
                                           crs = "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs")
subset_cl_nk <- st_as_sf(subset_cl_nk, coords = c("parcel_level_latitude", "parcel_level_longitude"), 
                                     crs = "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs")

county_parsely <- st_as_sf(county_parsely, coords = c("lat", "long"), 
                                           crs = "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs")
corelogic_parsley <- st_as_sf(corelogic_parsley, coords = c("parcel_level_latitude", "parcel_level_longitude"), 
                                     crs = "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs")


parsleytoparsley <- st_distance(county_parsely, corelogic_parsley)
geocoding_parsley_distances <- st_distance(county_parsely, subset_cl_nk)
min(geocoding_parsley_distances) 
geocoding_newkent_distances <- st_distance(subset_geocoded_nk, subset_cl_nk)

rownames(geocoding_newkent_distances) <- subset_geocoded_nk$`PID #`
colnames(geocoding_newkent_distances) <- rownames(subset_cl_nk)



min_dist <- apply(geocoding_newkent_distances, MARGIN = 1, FUN = min)

df = data.frame(PID = subset_geocoded_nk$`PID #`, min = min_dist) 

geocoding_newkent_distances %>% head() %>% as.numeric() #%>% transpose

geocoding_newkent_distances_num <- apply(geocoding_newkent_distances %>% as.data.frame(), MARGIN = 2, FUN = as.numeric)
geocoding_newkent_distances_num <- geocoding_newkent_distances_num %>% as.data.frame()

geocoding_newkent_distances_num %>% head()

for (i in 1:nrow(geocoding_newkent_distances_num)) {
  val <- geocoding_newkent_distances_num[i,] %>% reshape2::melt() %>% transmute(PID = i, CL = variable, dist = value) %>% filter(dist == min_dist[i]) %>% .$CL
  df$vals[i] <- as.numeric(val)
}
# df$vals <- NULL
# rm(i)

df
saveRDS(df, "~/git/dspg20broadbandERS/data/geocoding-output/min_dist_newkent_matches.RDS")

df <- readRDS("~/git/dspg20broadbandERS/data/geocoding-output/min_dist_newkent_matches.RDS")

df

max(min_dist)
min(min_dist)
table(min_dist > 1)
table(min_dist > 5)
table(min_dist > 10)

countydata <- subset_geocoded_nk %>% select(`PID #`, addr)
# st_geometry(countydata) <- NULL

cl_data <- subset_cl_nk %>% transmute(CL_ID = 1:nrow(.), situs_house_number, situs_street_name, situs_mode, situs_city, situs_state, situs_zip_code, apn__parcel_number_unformatted_, apn_sequence_number, original_apn)

df <- df %>% filter(min < 0.5) %>% 
  left_join(subset_geocoded_nk %>% select(`PID #`, addr), by = c("PID" = "PID #")) %>% 
  transmute(CTY_PID = PID, min_dist = min, CL_matches = vals, CTY_addr = addr) %>%
  left_join(cl_data, by = c("CL_matches" = "CL_ID"))

df %>% filter(min_dist <0.0001) 


library(stringr)
subset_cl_nk

subset_geocoded_nk %>% mutate(addr_broken = str_split(addr, pattern = ",")) %>% tidyr::unnest("addr_broken") %>% mutate(cat = ifelse(str_detect(addr_broken, "VA"), "STATE", 
       ifelse(str_detect(addr_broken, "\\d$"),"ZIP", 
        ifelse(str_detect(addr_broken, "^\\d") & str_detect(addr_broken, "[[:alpha:]]$"), "ADDR", "CITY" )))) 

CLdata2 <- subset_cl_nk %>% transmute(CL_ID = 1:nrow(.), situs_house_number, situs_street_name, situs_mode, situs_city, situs_state, situs_zip_code, apn__parcel_number_unformatted_, apn_sequence_number, original_apn, parcel_level_latitude, parcel_level_longitude)
CLdata2

"12110 Parsley Rd, New Kent, VA 23124"

subset_geocoded_nk %>% filter(str_detect(addr, "^12110"))
CLdata2 %>% filter(situs_house_number == "12110")

df %>% filter(str_detect(CTY_addr, "^12110"))
```



```{r eval = FALSE}


# county_parsely <- subset_geocoded_nk %>% filter(str_detect(addr, "^12110"))
# corelogic_parsley <- subset_cl_nk %>% filter(situs_house_number == "12110")

county_parsely <- subset_geocoded_nk %>% filter(str_detect(addr, "^12110") |str_detect(addr, "^8000 C"))
corelogic_parsley <- subset_cl_nk %>% 
  filter(situs_house_number == "12110" |
           (situs_house_number == "8000" & str_detect(situs_street_name, "^CURTIS")) 
           )


county_parsely <- county_parsely %>% mutate(state = str_trim(str_remove_all(str_extract(addr, ", [A-Z]{2},"), "[[:punct:]]")), 
                          zip = str_extract(addr, "\\d{5}$|\\d{9}$"),
                          street = str_remove(str_extract(addr, "^(.+?),"), ",$"), 
                          city = str_trim(str_remove_all(str_remove(str_remove(str_remove(addr, pattern = street), 
                                                       pattern = zip), pattern = state), pattern = ",")))

cl_parsley_addronly <- corelogic_parsley %>% 
  transmute(situs_street_a = str_trim(paste(situs_house_number, situs_street_name, ifelse(!is.na(situs_mode), situs_mode),"")),
            situs_city, situs_state, situs_zip_code)

county_parsely
cl_parsley_addronly

county_parsely %>% left_join(cl_parsley_addronly, by = c("street" = "situs_street_a")) #, 
                                                         "city" = "situs_city", 
                                                         "state" = "situs_state")) #c("state" = "situs_state"))

county_parsely$street
cl_parsley_addronly$situs_street_a

"0 OLD CHURCH RD, NEW KENT, VA, 23124	"
"CARRIAGE RD, PROVIDENCE FORGE, VA, 23140	"

subset_cl_nk %>% filter(str_detect(situs_house_number, "5950") & str_detect(situs_street_name, "TRINA"))
subset_cl_nk %>% filter(str_detect(situs_street_name, "CARRIAGE") & is.na(situs_house_number)) #%>% count(situs_house_number) 
# 0 OLD CHURCH - #56 rows NA, no 0 
# CARRIAGE ROAD - # 5 rows NA


corelogic_parsley <- subset_cl_nk %>% 
  filter(situs_house_number == "12110" |
           (situs_house_number == "8000" & str_detect(situs_street_name, "^CURTIS")) 
           )

```


```{r eval = FALSE}
county_matchable <- subset_geocoded_nk  %>% 
  mutate(state = str_trim(str_remove_all(str_extract(addr, ", [A-Z]{2},"), "[[:punct:]]")), 
                          zip = str_extract(addr, "\\d{5}$|\\d{9}$|\\d{5}(-\\d{4})?$"),
                          street = str_remove(str_extract(addr, "^(.+?),"), ",$"), 
                          city = str_trim(str_remove_all(str_remove(str_remove(str_remove(addr, pattern = street), 
                                                       pattern = zip), pattern = state), pattern = ","))) %>%
  filter(state == "VA") %>%
  filter(!is.na(city)) %>% 
  filter(str_detect(street, "^\\d") == TRUE) 

county_notmatchable <-  subset_geocoded_nk  %>% 
  mutate(state = str_trim(str_remove_all(str_extract(addr, ", [A-Z]{2},"), "[[:punct:]]")), 
                          zip = str_extract(addr, "\\d{5}$|\\d{9}$|\\d{5}(-\\d{4})?$"),
                          street = str_remove(str_extract(addr, "^(.+?),"), ",$"), 
                          city = str_trim(str_remove_all(str_remove(str_remove(str_remove(addr, pattern = street), 
                                                       pattern = zip), pattern = state), pattern = ","))) %>%
  filter(state != "VA"|is.na(city) |str_detect(street, "^\\d") == FALSE) 

nrow(county_matchable) + nrow(county_notmatchable) == nrow(subset_geocoded_nk)

##############

corelogic_matchable <- subset_cl_nk %>% 
  mutate(situs_street_a = str_trim(paste(situs_house_number, situs_street_name, 
                                         ifelse(!is.na(situs_mode), situs_mode, "")))) %>% 
  filter(!is.na(situs_house_number)) %>%
  filter(!is.na(situs_street_name)) %>%
  filter(!is.na(situs_city)) %>%
  filter(situs_state == "VA")

corelogic_notmatchable <- subset_cl_nk %>% 
  mutate(situs_street_a = str_trim(paste(situs_house_number, situs_street_name, 
                                         ifelse(!is.na(situs_mode), situs_mode, "")))) %>% 
  filter(is.na(situs_house_number) | is.na(situs_street_name) | is.na(situs_city) | situs_state != "VA")

nrow(corelogic_matchable) + nrow(corelogic_notmatchable) == nrow(subset_cl_nk)

```

```{r eval = FALSE}
nrow(county_matchable ) #8030
nrow(corelogic_matchable) #9244

length(unique(county_matchable$street))
length(unique(corelogic_matchable$situs_street_a))

# [1] 7913
# [1] 9138

dupes_CTY <- county_matchable %>% count(street) %>% filter(n > 1) %>% .$street
dupes_CL <- corelogic_matchable %>% count(situs_street_a) %>% filter(n > 1) %>% .$situs_street_a

county_matchable %>% filter(street %in% dupes_CTY)
subset_geocoded_nk %>% filter(str_detect(addr, paste0(dupes_CTY, collapse = "|")))
original_newkent_county %>% filter(str_detect(`Property Location`, paste0(dupes_CTY, collapse = "|"))) %>% arrange(desc(`Property Location`)) %>% count(`Property Location`)  %>% filter(n != 1) 

geocoded_newkent_county
```


```{r eval = FALSE}

### First round of matching on full street address: house number, street name, street type

nrow(county_matchable ) #8030
nrow(corelogic_matchable) #9244

county_corelogic_matched <- county_matchable %>% inner_join(corelogic_matchable, by = c("street" = "situs_street_a"))
county_corelogic_matched %>% select(1:8, 38:43,  14,34:35,  18:22 ) %>% select(2, 9:12)

county_corelogic_matchless <- county_matchable %>% anti_join(corelogic_matchable, by = c("street" = "situs_street_a"))
corelogic_county_matchless <- corelogic_matchable %>% anti_join(county_matchable, by = c("situs_street_a" = "street"))

#################

### Second round of matching on partial street address: house number, street name

county_corelogic_matchless <- county_corelogic_matchless %>% mutate(street_b = str_remove(street, "\\s[A-Z]{2}$"))
corelogic_county_matchless <- corelogic_county_matchless %>% mutate(situs_street_b = str_trim(paste(situs_house_number, situs_street_name)))

county_corelogic_matched_b <- county_corelogic_matchless %>% inner_join(corelogic_county_matchless, by = c("street_b" = "situs_street_b"))
county_corelogic_matched_b %>% select(street, street_b, situs_street_a)

county_corelogic_matchless_b <- county_corelogic_matchless %>% anti_join(corelogic_county_matchless, by = c("street_b" = "situs_street_b"))
corelogic_county_matchless_b <- corelogic_county_matchless %>% anti_join(county_corelogic_matchless, by = c("situs_street_b" = "street_b"))

"11525 WILDFOX LN, NEW KENT, VA, 23124" # Corelogic has WILD FOX with a space
"4440 N COURTHOUSE RD, PROVIDENCE FORGE, VA, 23140" #Corelogic does not have North
# "6419 MAPLE RD, QUINTON, VA, 23141" # CL has 3 diff maple Rd addresses, but not this one
# "6080 LAUREL BREEZE LN, BARHAMSVILLE, VA, 23011	" #Corelogic doesn't have any  laurel breeze
"21060 KIRBY'S FARM RD, BARHAMSVILLE, VA, 23011" #Corelogic doesn't have apostrophe
"	2930 CLAYMOUNT RD, PROVIDENCE FORGE, VA, 23140" #Corelogic doesn't have U 

county_corelogic_matchless_b
corelogic_county_matchless_b %>% filter(str_detect(situs_street_a, "2930")) %>% select(situs_street_a)

### Potential third round? - Apostrophes 

county_corelogic_matchless_b <- county_corelogic_matchless_b %>% 
  mutate(street_c = str_replace_all(str_remove_all(street, "[[:punct:]]"), pattern = "\\s(N|S|W)\\s", replacement = " "))
corelogic_county_matchless_b <- corelogic_county_matchless_b %>% 
  mutate(situs_street_c = str_replace_all(str_remove_all(situs_street_a, "[[:punct:]]"), pattern = "\\s(N|S|W)\\s", replacement = " "))

county_corelogic_matched_c <- county_corelogic_matchless_b %>% inner_join(corelogic_county_matchless_b, by = c("street_c" = "situs_street_c"))
county_corelogic_matched_c %>% select(street, street_b, situs_street_a)

county_corelogic_matchless_c <- county_corelogic_matchless_b %>% anti_join(corelogic_county_matchless_b, by = c("street_c" = "situs_street_c"))
corelogic_county_matchless_c <- corelogic_county_matchless_b %>% anti_join(county_corelogic_matchless_b, by = c("situs_street_c" = "street_c"))

"6010 SOUTH GARDEN RD, PROVIDENCE FORGE, VA, 23140	" # Corelogic doesn't have SOUTH
"815 W RIVERSIDE DR, LANEXA, VA, 23089	" #Missing entirely
"1000 W RIVERSIDE DR, LANEXA, VA, 23089	" # Missing entirely
"14801 STAGE RD, LANEXA, VA, 23089" # missing entirely
"6555 MARL SPRING DR, NEW KENT, VA, 23124	" # CL has plural springs
"4977 LYNN LAKE CT, BARHAMSVILLE, VA, 23011	" # CL missing space between Lynn & Lake
"5931 GOLDEN WHEEL RD, PROVIDENCE FORGE, VA, 23140" # Missing entirely 
"18119 NEW KENT HW, BARHAMSVILLE, VA, 23011	" # Missing entirely 

county_corelogic_matchless_c
corelogic_county_matchless_c %>% filter(str_detect(situs_street_a, "18119")) %>% select(situs_street_a)

res <- data.frame("Method" = c("1. Full Street Address", "2. Partial Street Address", "3. Apostrophes/Direction"),
           "Matched" = c(nrow(county_corelogic_matched), nrow(county_corelogic_matched_b), nrow(county_corelogic_matched_c)),
           "CTY_Left" = c(nrow(county_corelogic_matchless), nrow(county_corelogic_matchless_b), nrow(county_corelogic_matchless_c)),
           "CL_Left" = c(nrow(corelogic_county_matchless), nrow(corelogic_county_matchless_b), nrow(corelogic_county_matchless_c))
           )

nrow(county_matchable ) #8030
nrow(corelogic_matchable) #9244

res
sum(res$Matched)
sum(res$Matched) #+ 695 == 8030
```

```{r eval = FALSE}
# loc.validate_address(address_2 = county_corelogic_matchless_c$addr, state = "VA", zip5 = county_corelogic_matchless_c$zip)

library(sf)


sf1 <- county_corelogic_matched %>% st_as_sf(coords = c("long", "lat"))

county_corelogic_matched

library(leaflet)

leaflet() %>%
  addTiles() %>% 
  addCircleMarkers(lng = county_corelogic_matched$long, lat = county_corelogic_matched$lat)
```


```{r eval = FALSE}
8030 - (6085 + 2034)
9244 - (6085 + 3222)
```
















