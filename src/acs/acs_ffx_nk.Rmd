---
title: "ACS test"
author: "Morgan Klutzke"
date: "7/13/2020"
output: html_document
---

```{r}
library(tidycensus)
library(maps)
library(data.table)
library(magrittr)
library(maditr)
library(dplyr)
library(stringr)
library(ggplot2)

# API key here
census_api_key(Sys.getenv("CENSUS_API_KEY"))

# get a reference of variable IDs for 2018 ACS
v18 <- load_variables(2018, "acs5", cache = TRUE)
```

```{r}
# list variables we want for each census tract
acs_vars <- c("B25075_001", "B25075_002", "B25075_003", "B25075_004", "B25075_005", "B25075_006", "B25075_007", "B25075_008", "B25075_009", "B25075_010", "B25075_011", "B25075_012", "B25075_013", "B25075_014", "B25075_015", "B25075_016", "B25075_017", "B25075_018", "B25075_019", "B25075_020", "B25075_021", "B25075_022", "B25075_023", "B25075_024", "B25075_025", "B25075_026", "B25075_027", # value
              "B25077_001", # median value
              "B25001_001", # housing units
              "B25002_001", "B25002_002", "B25002_003",# occupancy status
              "B25024_001", "B25024_002", "B25024_003", "B25024_004", "B25024_005", "B25024_006", "B25024_007", "B25024_008", "B25024_009", "B25024_010", "B25024_011", # number of units
              "B25041_001", "B25041_002", "B25041_003", "B25041_004", "B25041_005", "B25041_006", "B25041_007", # number of bedrooms
              "B25034_001", "B25034_002", "B25034_003", "B25034_004", "B25034_005", "B25034_006", "B25034_007", "B25034_008", "B25034_009", "B25034_010", "B25034_011", # year built
              "B25035_001" # median year built
)

# function to clean raw ACS data
# keeps estimates and discards MOE
# adds descriptive variable names
get_estimates_wide <- function(acs_data) {
  return(
    transmute(
      acs_data,
      GEOID = GEOID,
      census_tract = str_extract(NAME, "(?<=Census Tract )[0-9.]*"),
      median_value = B25077_001E,
      median_value_moe = B25077_001M,
      value_total = B25075_001E,
      value_total_moe = B25075_001M,
      value_10orless = B25075_002E,
      value_10orless_moe = B25075_002M,
      value_10to15 = B25075_003E,
      value_10to15_moe = B25075_003M,
      value_15to20 = B25075_004E,
      value_15to20_moe = B25075_004M,
      value_20to25 = B25075_005E,
      value_20to25_moe = B25075_005M,
      value_25to30 = B25075_006E,
      value_25to30_moe = B25075_006M,
      value_30to35 = B25075_007E,
      value_30to35_moe = B25075_007M,
      value_35to40 = B25075_008E,
      value_35to40_moe = B25075_008M,
      value_40to50 = B25075_009E,
      value_40to50_moe = B25075_009M,
      value_50to60 = B25075_010E,
      value_50to60_moe = B25075_010M,
      value_60to70 = B25075_011E,
      value_60to70_moe = B25075_011M,
      value_70to80 = B25075_012E,
      value_70to80_moe = B25075_012M,
      value_80to90 = B25075_013E,
      value_80to90_moe = B25075_013M,
      value_90to100 = B25075_014E,
      value_90to100_moe = B25075_014M,
      value_100to125 = B25075_015E,
      value_100to125_moe = B25075_015M,
      value_125to150 = B25075_016E,
      value_125to150_moe = B25075_016M,
      value_150to175 = B25075_017E,
      value_150to175_moe = B25075_017M,
      value_175to200 = B25075_018E,
      value_175to200_moe = B25075_018M,
      value_200to250 = B25075_019E,
      value_200to250_moe = B25075_019M,
      value_250to300 = B25075_020E,
      value_250to300_moe = B25075_020M,
      value_300to400 = B25075_021E,
      value_300to400_moe = B25075_021M,
      value_400to500 = B25075_022E,
      value_400to500_moe = B25075_022M,
      value_500to750 = B25075_023E,
      value_500to750_moe = B25075_023M,
      value_750to1000 = B25075_024E,
      value_750to1000_moe = B25075_024M,
      value_1000to1500 = B25075_025E,
      value_1000to1500_moe = B25075_025M,
      value_1500to2000 = B25075_026E,
      value_1500to2000_moe = B25075_026M,
      value_2000plus = B25075_027E,
      value_2000plus_moe = B25075_027M,
      median_yrbuilt = B25035_001E,
      median_yrbuilt_moe = B25035_001M,
      yrbuilt_total = B25034_001E,
      yrbuilt_total_moe = B25034_001M,
      yrbuilt_2014orlater = B25034_002E,
      yrbuilt_2014orlater_moe = B25034_002M,
      yrbuilt_2010to2013 = B25034_003E,
      yrbuilt_2010to2013_moe = B25034_003M,
      yrbuilt_2000to2009 = B25034_004E,
      yrbuilt_2000to2009_moe = B25034_004M,
      yrbuilt_1990to1999 = B25034_005E,
      yrbuilt_2000to2009_moe = B25034_004M,
      yrbuilt_1980to1989 = B25034_006E,
      yrbuilt_1980to1989_moe = B25034_006M,
      yrbuilt_1970to1979 = B25034_007E,
      yrbuilt_1970to1979_moe = B25034_007M,
      yrbuilt_1960to1969 = B25034_008E,
      yrbuilt_1960to1969_moe = B25034_008M,
      yrbuilt_1950to1959 = B25034_009E,
      yrbuilt_1950to1959_moe = B25034_009M,
      yrbuilt_1940to1949 = B25034_010E,
      yrbuilt_1940to1949_moe = B25034_010M,
      yrbuilt_1939orearlier = B25034_011E,
      yrbuilt_1939orearlier_moe = B25034_011M,
      bed_total = B25041_001E,
      bed_total_moe = B25041_001M,
      bed_none = B25041_002E,
      bed_none_moe = B25041_002M,
      bed_1 = B25041_003E,
      bed_1_moe = B25041_003M,
      bed_2 = B25041_004E,
      bed_2_moe = B25041_004M,
      bed_3 = B25041_005E,
      bed_3_moe = B25041_005M,
      bed_4 = B25041_006E,
      bed_4_moe = B25041_006M,
      bed_5plus = B25041_007E,
      bed_5plus_moe = B25041_007M,
      hunits_total = B25001_001E,
      hunits_total_moe = B25001_001M,
      occstatus_total = B25002_001E,
      occstatus_total_moe = B25002_001M,
      occstatus_occup = B25002_002E,
      occstatus_occup_moe = B25002_002M,
      occstatus_vac = B25002_003E,
      occstatus_vac_moe = B25002_003M,
      unitno_total = B25024_001E,
      unitno_total_moe = B25024_001M,
      unitno_1det = B25024_002E,
      unitno_1det_moe = B25024_002M,
      unitno_1at = B25024_003E,
      unitno_1at_moe = B25024_003M,
      unitno_2 = B25024_004E,
      unitno_2_moe = B25024_004M,
      unitno_3or4 = B25024_005E,
      unitno_3or4_moe = B25024_005M,
      unitno_5to9 = B25024_006E,
      unitno_5to9_moe = B25024_006M,
      unitno_10to19 = B25024_007E,
      unitno_10to19_moe = B25024_007M,
      unitno_20to49 = B25024_008E,
      unitno_20to49_moe = B25024_008M,
      unitno_50plus = B25024_009E,
      unitno_50plus_moe = B25024_009M,
      unitno_mobile = B25024_010E,
      unitno_mobile_moe = B25024_010M,
      unitno_other = B25024_011E,
      unitno_other_moe = B25024_011M
    )
  )
}

get_estimates_tidy <- function(acs_data) {
  acs_data <- as.data.table(acs_data) %>%
    dt_mutate(NAME = str_extract(NAME, "(?<=Census Tract )[0-9.]*")) %>%
    rename(census_tract = NAME) %>%
    dt_mutate(variable = str_replace(variable, "B25077_001", "value median")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_001", "value total")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_002", "value <10")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_003", "value 10-15")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_004", "value 15-20")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_005", "value 20-25")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_006", "value 25-30")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_007", "value 30-35")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_008", "value 35-40")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_009", "value 40-50")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_010", "value 50-60")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_011", "value 60-70")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_012", "value 70-80")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_013", "value 80-90")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_014", "value 90-100")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_015", "value 100-125")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_016", "value 125-150")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_017", "value 150-175")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_018", "value 175-200")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_019", "value 200-250")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_020", "value 250-300")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_021", "value 300-400")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_022", "value 400-500")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_023", "value 500-750")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_024", "value 750-1000")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_025", "value 1000-1500")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_026", "value 1500-2000")) %>%
    dt_mutate(variable = str_replace(variable, "B25075_027", "value >2000")) %>%
    dt_mutate(variable = str_replace(variable, "B25035_001", "yrbuilt median")) %>%
    dt_mutate(variable = str_replace(variable, "B25034_001", "yrbuilt total")) %>%
    dt_mutate(variable = str_replace(variable, "B25034_002", "yrbuilt 2014-later")) %>%
    dt_mutate(variable = str_replace(variable, "B25034_003", "yrbuilt 2010-2013")) %>%
    dt_mutate(variable = str_replace(variable, "B25034_004", "yrbuilt 2000-2009")) %>%
    dt_mutate(variable = str_replace(variable, "B25034_005", "yrbuilt 1990-1999")) %>%
    dt_mutate(variable = str_replace(variable, "B25034_006", "yrbuilt 1980-1989")) %>%
    dt_mutate(variable = str_replace(variable, "B25034_007", "yrbuilt 1970-1979")) %>%
    dt_mutate(variable = str_replace(variable, "B25034_008", "yrbuilt 1960-1969")) %>%
    dt_mutate(variable = str_replace(variable, "B25034_009", "yrbuilt 1950-1959")) %>%
    dt_mutate(variable = str_replace(variable, "B25034_010", "yrbuilt 1940-1949")) %>%
    dt_mutate(variable = str_replace(variable, "B25034_011", "yrbuilt earlier-1939")) %>%
    dt_mutate(variable = str_replace(variable, "B25041_001", "bedrooms total")) %>%
    dt_mutate(variable = str_replace(variable, "B25041_002", "bedrooms none")) %>%
    dt_mutate(variable = str_replace(variable, "B25041_003", "bedrooms 1")) %>%
    dt_mutate(variable = str_replace(variable, "B25041_004", "bedrooms 2")) %>%
    dt_mutate(variable = str_replace(variable, "B25041_005", "bedrooms 3")) %>%
    dt_mutate(variable = str_replace(variable, "B25041_006", "bedrooms 4")) %>%
    dt_mutate(variable = str_replace(variable, "B25041_007", "bedrooms 5+")) %>%
    dt_mutate(variable = str_replace(variable, "B25001_001", "housing_units total")) %>%
    dt_mutate(variable = str_replace(variable, "B25002_001", "occupancy_status total")) %>%
    dt_mutate(variable = str_replace(variable, "B25002_002", "occupancy_status occupied")) %>%
    dt_mutate(variable = str_replace(variable, "B25002_003", "occupancy_status vacant")) %>%
    dt_mutate(variable = str_replace(variable, "B25024_001", "unit_no total")) %>%
    dt_mutate(variable = str_replace(variable, "B25024_002", "unit_no 1 detached")) %>%
    dt_mutate(variable = str_replace(variable, "B25024_003", "unit_no 1 attached")) %>%
    dt_mutate(variable = str_replace(variable, "B25024_004", "unit_no 2")) %>%
    dt_mutate(variable = str_replace(variable, "B25024_005", "unit_no 3-4")) %>%
    dt_mutate(variable = str_replace(variable, "B25024_006", "unit_no 5-9")) %>%
    dt_mutate(variable = str_replace(variable, "B25024_007", "unit_no 10-19")) %>%
    dt_mutate(variable = str_replace(variable, "B25024_008", "unit_no 20-49")) %>%
    dt_mutate(variable = str_replace(variable, "B25024_009", "unit_no 50+")) %>%
    dt_mutate(variable = str_replace(variable, "B25024_010", "unit_no mobile")) %>%
    dt_mutate(variable = str_replace(variable, "B25024_011", "unit_no other")) %>%
    dt_mutate(value = str_extract(variable, "(?<=\\s).+")) %>%
    dt_mutate(variable = str_extract(variable, "[a-z_]+")) %>%
    setcolorder(c("GEOID", "census_tract", "variable", "value", "estimate", "moe")) %>%
    dt_mutate(lower_ci = estimate - moe) %>%
    dt_mutate(upper_ci = estimate + moe) %>%
    dt_mutate(lower_ci = if_else(condition = lower_ci < 0, true = 0, false = lower_ci))
}

# get data for fairfax county
ffx <- get_acs(geography = "tract", state = 51, county = 059,
               variables = acs_vars,
               year = 2018, survey = "acs5",
               cache_table = TRUE)
ffx_estimates <- get_estimates_tidy(ffx)

# get data for new kent country
nk <- get_acs(geography = "tract", state = 51, county = 127,
              variables = acs_vars,
              year = 2018, survey = "acs5",
              cache_table = TRUE)
nk_estimates <- get_estimates_tidy(nk)
```

Visualizations

```{r, fig.height=7}
get_values <- function(estimates) {
  values <- estimates %>%
    filter(variable == "value") %>%
    filter(value != "median" & value != "total") %>%
    group_by(value) %>%
    summarise(n = sum(estimate), lower_sum = sum(lower_ci), upper_sum = sum(upper_ci)) %>%
    dt_mutate(value = factor(value, levels = c("<10", "10-15", "15-20", "20-25", "25-30", "30-35", "35-40", "40-50", "50-60", "60-70", "70-80", "80-90", "90-100", "100-125", "125-150", "150-175", "175-200", "200-250", "250-300", "300-400", "400-500", "500-750", "750-1000", "1000-1500", "1500-2000", ">2000"))) %>%
    arrange(value)
}

nk_values <- get_values(nk_estimates)
ffx_values <- get_values(ffx_estimates)

ggplot(nk_values) + geom_col(aes(x = value, y = n)) + geom_errorbar(aes(x = value, ymin = lower_sum, ymax = upper_sum)) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) + labs(x = "value (thousands of $)", title = "New Kent")

ggplot(ffx_values) + geom_col(aes(x = value, y = n)) + geom_errorbar(aes(x = value, ymin = lower_sum, ymax = upper_sum)) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) + labs(x = "value (thousands of $)", title = "New Kent")
```




```{r, fig.height=7}
library(ggplot2)
library(tidyr)

ffx_values <- summarise(ffx_estimates, across(value_10orless:value_2000plus, sum)) %>%
  pivot_longer(cols = 1:26 , names_to = "value", values_to = "count") %>%
  mutate(value = str_replace_all(value, "value_", "")) %>%
  mutate(value = str_replace_all(value, "to", "-")) %>%
  mutate(value = str_replace_all(value, "10orless", "<10")) %>%
  mutate(value = str_replace_all(value, "2000plus", "2000<")) %>%
  mutate(value = factor(value, levels = value))

ggplot(ffx_values) + geom_col(aes(x = value, y = count)) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) + labs(x = "value (thousands of $)", title = "Fairfax")

nk_values <- summarise(nk_estimates, across(value_10orless:value_2000plus, sum)) %>%
  pivot_longer(cols = 1:26 , names_to = "value", values_to = "count") %>%
  mutate(value = str_replace_all(value, "value_", "")) %>%
  mutate(value = str_replace_all(value, "to", "-")) %>%
  mutate(value = str_replace_all(value, "10orless", "<10")) %>%
  mutate(value = str_replace_all(value, "2000plus", "2000<")) %>%
  mutate(value = factor(value, levels = value))

ggplot(nk_values) + geom_col(aes(x = value, y = count)) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) + labs(x = "value (thousands of $)", title = "New Kent")
```

```{r, fig.height=7}
ffx_yrbuilt <- summarise(ffx_estimates, across(yrbuilt_2014orlater:yrbuilt_1939orearlier, sum)) %>%
  pivot_longer(cols = 1:10 , names_to = "yrbuilt", values_to = "count") %>%
  mutate(yrbuilt = str_replace_all(yrbuilt, "yrbuilt_", "")) %>%
  mutate(yrbuilt = str_replace_all(yrbuilt, "to|or", "-")) %>%
  mutate(yrbuilt = str_replace(yrbuilt, "1939-earlier", "earlier-1939")) %>%
  mutate(yrbuilt = factor(yrbuilt, levels = yrbuilt))

ggplot(ffx_yrbuilt) + geom_col(aes(x = yrbuilt, y = count)) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) + labs(x = "year built", title = "Fairfax")

nk_yrbuilt <- summarise(nk_estimates, across(yrbuilt_2014orlater:yrbuilt_1939orearlier, sum)) %>%
  pivot_longer(cols = 1:10 , names_to = "yrbuilt", values_to = "count") %>%
  mutate(yrbuilt = str_replace_all(yrbuilt, "yrbuilt_", "")) %>%
  mutate(yrbuilt = str_replace_all(yrbuilt, "to|or", "-")) %>%
  mutate(yrbuilt = str_replace(yrbuilt, "1939-earlier", "earlier-1939")) %>%
  mutate(yrbuilt = factor(yrbuilt, levels = yrbuilt))

ggplot(nk_yrbuilt) + geom_col(aes(x = yrbuilt, y = count)) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) + labs(x = "year built", title = "New Kent")
```

